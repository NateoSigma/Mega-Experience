<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Mega Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      background-color: #1e1e1e;
      color: #fff;
      text-align: center;
      margin: 0;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(10, 35px);
      grid-template-rows: repeat(10, 35px);
      gap: 2px;
      justify-content: center;
      margin: 10px auto;
    }
    #mapSelector {
  margin: 10px auto;
  display: flex;
  justify-content: center;
  gap: 10px;
}
#actions {
  margin: 10px auto;
}
#actions button {
  margin: 5px;
  padding: 8px 15px;
  background-color: #4caf50;
  border: none;
  border-radius: 10px;
  color: white;
  font-size: 16px;
}
#mapSelector button {
  background: #555;
  color: white;
  padding: 8px 16px;
  border-radius: 10px;
  border: none;
  font-size: 16px;
}
    #ognisko {
      margin: 10px auto;
      width: 95%;
      max-width: 500px;
      background: #2e2e2e;
      padding: 10px;
      color: #b08968;
      border-radius: 10px;
      text-align: centre;
    }
#inventory ul {
  padding-left: 20px;
  margin: 0;
}

#inventory li {
  list-style: "🔹 ";
}

#ui {
  display: none; /* DOM istnieje, ale niewidoczny */
}

#ui.visible {
  display: block;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fefae0;
  border: 3px solid #b08968;
  border-radius: 12px;
  padding: 20px;
  z-index: 999;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  max-width: 90%;
  width: 300px;
  font-family: 'Segoe UI', sans-serif;
  text-align: center;
  animation: fadeIn 0.3s ease-in-out;
}

#ui h3 {
  margin-top: 0;
  font-size: 20px;
  color: #6d4c41;
}

#ui p {
  margin: 10px 0;
  color: #333;
}

#ui button {
  margin: 6px 0;
  padding: 8px 12px;
  background-color: #a5d6a7;
  color: #000;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  width: 100%;
  font-weight: bold;
  transition: background-color 0.2s;
}

#ui button:hover {
  background-color: #81c784;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translate(-50%, -55%); }
  to { opacity: 1; transform: translate(-50%, -50%); }
}

.merchant {
  background-color: #ffeaa7;
  border: 2px solid goldenrod;
  font-size: 18px;
  text-align: center;
}

    .cell {
      width: 35px;
      height: 35px;
      background-color: #444;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      border-radius: 5px;
    }
    .tomato::after { content: "🍅"; }
    .player { background-color: #0f0; }
    .stick::after { content: "🌿"; }
    .stone::after { content: "🪨"; }
    .sand::after { content: "🟡"; }
    .coal::after { content: "🌑"; }
    .carrot::after { content: "🥕"; }
    .cow::after { content: "🐄"; }
    .campfire::after { content: "🔥"; }
    .tree::after { content: "🌳"; }
    .skeleton::after { content: "💀"; }
    .cactus::after { content: "🌵"; }
    .pig::after { content: "🐖"; }
    #controls {
      display: grid;
      grid-template-columns: repeat(3, 60px);
      grid-template-rows: repeat(3, 60px);
      gap: 5px;
      justify-content: center;
    }
    .btn {
      background: #666;
      color: #fff;
      font-size: 24px;
      border: none;
      border-radius: 10px;
    }
    #inventory {
      margin: 10px auto;
      width: 95%;
      max-width: 500px;
      background: #2e2e2e;
      padding: 10px;
      border-radius: 10px;
      text-align: left;
    }
    .durability-bar {
      height: 10px;
      background: #444;
      border-radius: 5px;
      overflow: hidden;
      margin: 3px 0;
    }
    .durability {
      height: 100%;
      background: #4caf50;
    }
    #crafting button {
      margin: 5px;
      padding: 8px 15px;
      background-color: #888;
      border: none;
      border-radius: 10px;
      color: white;
    }
  </style>
</head>
<body>

<h1>Mega Experience</h1>
<div id="timeLabel">🌞 Dzień</div>
<div style="margin: 20px;">
  <button onclick="resetGame()" style="background: crimson; padding: 10px 20px; font-size: 16px; border-radius: 10px;">
    🔄 Zresetuj grę
  </button>
</div>


<div id="ognisko">
    <button onclick="placeCampfire()">📍 Postaw ognisko</button>
    <button onclick="collectNearbyCampfire()" style="margin-top:10px;">🔥 Zbierz ognisko</button>
</div>

<div id="mapSelector">
  <button onclick="setBiome('forest')">🌲 Las</button>
  <button onclick="setBiome('desert')">🏜️ Pustynia</button>
  <button onclick="setBiome('cave')">⛰ Jaskinia</button>
</div>

<div id="ui"></div>
<div id="board"></div>

<div id="controls">
  <div></div><button class="btn" onclick="move('up')">⬆</button><div></div>
  <button class="btn" onclick="move('left')">⬅</button><div></div><button class="btn" onclick="move('right')">➡</button>
  <div></div><button class="btn" onclick="move('down')">⬇</button><div></div>
</div>

<div id="actions">
  <button onclick="eatApple()">Zjedz jabłko (+2 HP)</button>
  <button onclick="eatTomato()">Zjedz pomidora (+0.5 HP)</button>
  <button onclick="eatCookedMeat()">Zjedz mięso (+5 HP)</button>
  <button onclick="eatCarrot()">Zjedz marchewkę (+1 HP)</button>
</div>

<div id="inventory"></div>

<div id="crafting">
  <button onclick="craftAxe()">🪓 Siekiera (3patyki  2kamienie)</button>
  <button onclick="craftPickaxe()">⛏️ Kilof (3patyki  5kamienie)</button>
  <button onclick="craftSword()">🗡️ Miecz (3patyki  10kamienie)</button>
  <button onclick="craftDagger()">🔪 Sztylet (2patyki  7kamienie)</button>
  <button onclick="craftChair()">🪑 Krzesło (2drewno  6patyki)</button>
  <button onclick="craftCampfire()">🔥 Ognisko (8drewno  4węgla)</button>
</div>

<script>
const size = 10;
const board = document.getElementById('board');
let playerX = 0, playerY = 0, isDay = true;
let worldX = 0, worldY = 0;
let currentBiome = 'forest';
let playerHP = 20;
let campfires = [];
let cows = [];
let skeletons = [];
let merchant = null;
let coal = [];
let worlds = {};
let carrots = [];
let day = 1;

let inventory = {
  sticks: 0, stones: 0, wood: 0, meat: 0, apples: 0,
  tomatoes: 0, sand: 0, cactus: 0, campfires: 0, 
  bones: 0, cactusFlower: 0, chairs: 0, carrots: 0,
  sword: false, swordDurability: 0, pickaxe: false,
  pickaxeDurability: 0,
  axe: false, axeDurability: 0, cookedMeat: 0,
  dagger: false, daggerDurability: 0
};

let tomatoes = []; let sand = []; let cacti = [];
let sticks = [], stones = [], trees = [], pigs = [];

function getCellIndex(x, y) {
  return y * size + x;
}

function setBiome(biome) {
  currentBiome = biome;
  generateMapForBiome();
  renderBoard();
}

function generateItems(arr, count) {
  let tries = 0;
  while (arr.length < count && tries < 1000) {
    const x = Math.floor(Math.random() * size);
    const y = Math.floor(Math.random() * size);
    const occupied = [sticks, stones, trees, pigs].some(group =>
      group.some(i => i.x === x && i.y === y)
    );
    if ((x !== playerX || y !== playerY) && !occupied) {
      arr.push({x, y});
    }
    tries++;
  }
}

function renderBoard() {
  board.innerHTML = '';
  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      const cell = document.createElement('div');
      cell.className = 'cell';

      if (x === playerX && y === playerY) {
        cell.classList.add('player');
      } if (merchant && merchant.x === x && merchant.y === y) {
  cell.classList.add('merchant');
  cell.textContent = '👳';
} else {
        const objMap = [
          { arr: sticks, cls: 'stick' },
          { arr: stones, cls: 'stone' },
          { arr: skeletons, cls: 'skeleton' },
          { arr: trees, cls: 'tree' },
          { arr: campfires, cls: 'campfire' },
          { arr: carrots, cls: 'carrot' },
          { arr: cows, cls: 'cow' },
          { arr: sand, cls: 'sand' },
          { arr: tomatoes, cls: 'tomato' },
          { arr: coal, cls: 'coal' },
          { arr: cacti, cls: 'cactus' },
          { arr: pigs, cls: 'pig' }
        ];

        for (const { arr, cls } of objMap) {
          if (arr.some(i => i.x === x && i.y === y)) {
            cell.classList.add(cls);
            break;
          }
        }
      }

      board.appendChild(cell);
    }
  }

  updateInventory();
  updateTimeLabel();
  saveGame();
}

function spawnMerchant() {
  // losowe miejsce poza graczem
  let x, y;
  do {
    x = Math.floor(Math.random() * size);
    y = Math.floor(Math.random() * size);
  } while (x === playerX && y === playerY);

  merchant = { x, y };
}

function generateMapForBiome() {
  sticks = [];
  stones = [];
  trees = [];
  carrots = [];
  pigs = [];
  cows = [];
  tomatoes = [];

  if (currentBiome === 'forest') {
    generateItems(sticks, 6);
    generateItems(stones, 6);
    generateItems(trees, 4);
    generateItems(cows, 2);
    generateItems(pigs, 2);
    generateItems(carrots, 3);
    generateItems(tomatoes, 3);
  }

  if (currentBiome === 'desert') {
    generateItems(sand, 10);
    generateItems(cacti, 3);
  }

  if (currentBiome === 'cave') {
    generateItems(stones, 8); 
    generateItems(coal, 3);
  }
}

function collectNearbyCampfire() {
  for (let i = 0; i < campfires.length; i++) {
    const fire = campfires[i];
    const dx = Math.abs(fire.x - playerX);
    const dy = Math.abs(fire.y - playerY);

    // Gracz jest maksymalnie 1 kratkę od ogniska, ale nie na nim
    if ((dx <= 1 && dy <= 1) && !(dx === 0 && dy === 0)) {
      inventory.campfires = (inventory.campfires || 0) + 1;
      campfires.splice(i, 1); // usuń ognisko z mapy
      saveGame();
      renderBoard();
      updateInventory();
      return;
    }
  }
}

function move(dir) {
  if (dir === 'up') {
    if (playerY === 0) {
      worldY--;
      playerY = size - 1;
    } else {
      playerY--;
    }
  } else if (dir === 'down') {
    if (playerY === size - 1) {
      worldY++;
      playerY = 0;
    } else {
      playerY++;
    }
  } else if (dir === 'left') {
    if (playerX === 0) {
      worldX--;
      playerX = size - 1;
    } else {
      playerX--;
    }
  } else if (dir === 'right') {
    if (playerX === size - 1) {
      worldX++;
      playerX = 0;
    } else {
      playerX++;
    }
  }

  interact();
  moveSkeletons();
  renderBoard();
}

function moveSkeletons() {
  for (let skel of skeletons) {
    let dx = playerX - skel.x;
    let dy = playerY - skel.y;

    // Ruch w osi X, jeśli odległość większa
    if (Math.abs(dx) > Math.abs(dy)) {
      skel.x += Math.sign(dx);
    } else if (dy !== 0) {
      skel.y += Math.sign(dy);
    }
  }

  // Po ruchu szkieletów sprawdzamy interakcję
  interact();
}

function interact() {
  sticks = sticks.filter(i => {
    if (i.x === playerX && i.y === playerY) {
      inventory.sticks++;
      return false;
    }
    return true;
  });
  stones = stones.filter(i => {
    if (i.x === playerX && i.y === playerY) {
      inventory.stones++;
      return false;
    }
    return true;
  });
  sand = sand.filter(i => {
  if (i.x === playerX && i.y === playerY) {
    inventory.sand = (inventory.sand || 0) + 1;
    return false;
  }
  return true;
});
carrots = carrots.filter(i => {
  if (i.x === playerX && i.y === playerY) {
    inventory.carrots = (inventory.carrots || 0) + 1;
    saveGame();
    return false;
  }
  return true;
});
coal = coal.filter(i => {
  if (i.x === playerX && i.y === playerY) {
    if (inventory.pickaxe) {
      inventory.coal = (inventory.coal || 0) + 1;
      inventory.pickaxeDurability--;
      if (inventory.pickaxeDurability <= 0) {
        inventory.pickaxe = false;
        alert("⛏️ Twój kilof się zepsuł!");
      }
      return false;
    } else {
      alert("❌ Potrzebujesz kilofa, żeby wykopać węgiel!");
    }
  }
  return true;
});
campfires.forEach(fire => {
  if (fire.x === playerX && fire.y === playerY) {
    if (inventory.meat > 0) {
      const cooked = inventory.meat;
      inventory.meat = 0;
      inventory.cookedMeat += cooked;
      alert(`🍖 Ugotowałeś ${cooked}x mięso!`);
    }
  }
});

if (merchant && playerX === merchant.x && playerY === merchant.y) {
  openMerchantTrade();
}

skeletons = skeletons.filter(i => {
  if (i.x === playerX && i.y === playerY) {
    if (inventory.sword) {
      inventory.bones = (inventory.bones || 0) + 1;
      inventory.swordDurability--;
      if (inventory.swordDurability <= 0) inventory.sword = false;
      return false; // szkielet pokonany
    } else {
      playerHP -= 2; // obrażenia od szkieleta
      if (playerHP <= 0) {
        alert("💀 Zginąłeś od szkieleta! Gra została zresetowana.");
        localStorage.removeItem('survivalGame');
        location.reload();
        return false;
      }
    }
  }
  return true;
});
cacti = cacti.filter(i => {
  if (i.x === playerX && i.y === playerY) {
    playerHP--;
    inventory.cactus = (inventory.cactus || 0) + 1;

    if (Math.random() < 0.07) {
      inventory.cactusFlower = (inventory.cactusFlower || 0) + 1;
    }

    saveGame();

    if (playerHP <= 0) {
      alert("💀 Kaktus cię zabił!");
      resetGame();
      return false;
    }
    return false;
  }
  return true;
});
  trees = trees.filter(i => {
    if (i.x === playerX && i.y === playerY && inventory.axe) {
      inventory.wood++;
      if (Math.random() < 0.2) inventory.apples++; // 20% szans na jabłko 🍎
      inventory.axeDurability--;
      if (inventory.axeDurability <= 0) inventory.axe = false;
      return false;
    }
    return true;
  });
  tomatoes = tomatoes.filter(i => {
  if (i.x === playerX && i.y === playerY) {
    inventory.tomatoes = (inventory.tomatoes || 0) + 1;
    return false;
  }
  return true;
});
cows = cows.filter(i => {
  if (i.x === playerX && i.y === playerY) {
    if (inventory.dagger || inventory.sword) {
      inventory.meat += 2; // krowa daje więcej mięsa
      if (inventory.dagger) {
        inventory.daggerDurability--;
        if (inventory.daggerDurability <= 0) inventory.dagger = false;
      }
      if (inventory.sword) {
        inventory.swordDurability--;
        if (inventory.swordDurability <= 0) inventory.sword = false;
      }
      return false;
    } else {
      playerHP -= 1; // krowa też może uderzyć 🐄💢
      if (playerHP <= 0) {
        alert("💀 Zginąłeś stratowany przez krowę!");
        resetGame();
        return false;
      }
    }
  }
  return true;
});
  pigs = pigs.filter(i => {
  if (i.x === playerX && i.y === playerY) {
    if (inventory.dagger) {
      inventory.meat++;
      inventory.daggerDurability--;
      if (inventory.daggerDurability <= 0) inventory.dagger = false;
      return false;
    } else {
      playerHP--;
      saveGame();
      if (playerHP <= 0) {
  alert("💀 Zginąłeś! Tracisz cały ekwipunek.");
  inventory = {
    sticks: 0, stones: 0, wood: 0, meat: 0, apples: 0,
    tomatoes: 0, sand: 0, cactus: 0, chairs: 0,
    axe: false, axeDurability: 0,
    dagger: false, daggerDurability: 0
  };
  playerHP = 20;
  playerX = 0;
  playerY = 0;
  worldX = 0;
  worldY = 0;
  generateMapForBiome();
  renderBoard();
  return false;
}
    }
  }
  return true;
});
}

function eatApple() {
  if (inventory.apples > 0 && playerHP < 20) {
    inventory.apples--;
    playerHP = Math.min(playerHP + 2, 20);
    saveGame();
    renderBoard();
  } else {
    alert("Nie masz jabłek lub masz pełne zdrowie!");
  }
}

function eatTomato() {
  if ((inventory.tomatoes || 0) > 0 && playerHP < 20) {
    inventory.tomatoes--;
    playerHP = Math.min(playerHP + 0.5, 20);
    saveGame();
    renderBoard();
  } else {
    alert("Nie masz pomidorów lub masz pełne zdrowie!");
  }
}

function eatCookedMeat() {
  if (inventory.cookedMeat > 0 && playerHP < 20) {
    inventory.cookedMeat--;
    playerHP = Math.min(20, playerHP + 5);
    renderBoard();
  }
}

function eatCarrot() {
  if ((inventory.carrots || 0) > 0 && playerHP < 20) {
    inventory.carrots--;
    playerHP = Math.min(20, playerHP + 1);
    updateInventory();
    saveGame();
  } else {
    alert("❌ Nie masz marchewek lub masz pełne zdrowie!");
  }
}

function updateInventory() {
  let inv = `
    <h3>🎒 Ekwipunek:</h3>
    <ul style="text-align: left; line-height: 1.6;">
      <li>Drewno: ${inventory.wood}</li>
      <li>Gotowe mięso: ${inventory.cookedMeat || 0}</li>
      <li>Jabłka: ${inventory.apples}</li>
      <li>Kaktusy: ${inventory.cactus || 0}</li>
      <li>Kamienie: ${inventory.stones}</li>
      <li>Kości: ${inventory.bones || 0}</li>
      <li>Krzesło: ${inventory.chairs || 0}</li>
      <li>Kwiaty kaktusa: ${inventory.cactusFlower || 0}</li>
      <li>Marchewki: ${inventory.carrots || 0}</li>
      <li>Mięso: ${inventory.meat}</li>
      <li>Ogniska: ${inventory.campfires || 0}</li>
      <li>Patyki: ${inventory.sticks}</li>
      <li>Piasek: ${inventory.sand || 0}</li>
      <li>Pomidory: ${inventory.tomatoes || 0}</li>
      <li>Węgiel: ${inventory.coal || 0}</li>
    </ul>

    <p>❤️ Zdrowie: ${playerHP.toFixed(1)}/20</p>
    <div class="durability-bar">
      <div class="durability" style="width:${playerHP * 5}%; background:#f44336;"></div>
    </div>
  `;

  if (inventory.axe) {
    inv += `
      <p>🪓 Siekiera (Wytrzymałość: ${inventory.axeDurability}/15)</p>
      <div class="durability-bar">
        <div class="durability" style="width:${(inventory.axeDurability / 15) * 100}%;"></div>
      </div>
    `;
  }

  if (inventory.sword) {
    inv += `
      <p>🗡️ Miecz (Wytrzymałość: ${inventory.swordDurability}/10)</p>
      <div class="durability-bar">
        <div class="durability" style="width:${(inventory.swordDurability / 10) * 100}%; background:#aaa;"></div>
      </div>
    `;
  }

  if (inventory.pickaxe) {
    inv += `
      <p>⛏️ Kilof (Wytrzymałość: ${inventory.pickaxeDurability}/12)</p>
      <div class="durability-bar">
        <div class="durability" style="width:${(inventory.pickaxeDurability / 12) * 100}%; background:#555;"></div>
      </div>
    `;
  }

  if (inventory.dagger) {
    inv += `
      <p>🔪 Sztylet (Wytrzymałość: ${inventory.daggerDurability}/7)</p>
      <div class="durability-bar">
        <div class="durability" style="width:${(inventory.daggerDurability / 7) * 100}%;"></div>
      </div>
    `;
  }

  document.getElementById('inventory').innerHTML = inv;
}

function craftAxe() {
  if (inventory.sticks >= 3 && inventory.stones >= 2) {
    inventory.sticks -= 3;
    inventory.stones -= 2;
    inventory.axe = true;
    inventory.axeDurability = 15;
    renderBoard();
  }
}

function craftChair() {
  if ((inventory.wood || 0) >= 2 && (inventory.sticks || 0) >= 6) {
    inventory.wood -= 2;
    inventory.sticks -= 6;
    inventory.chairs = (inventory.chairs || 0) + 1;
    updateInventory();
    saveGame();
    alert("🪑 Udało się stworzyć krzesło!");
  } else {
    alert("❌ Potrzebujesz 2x drewno i 6x patyków.");
  }
}

function craftPickaxe() {
  if (inventory.sticks >= 3 && inventory.stones >= 5) {
    inventory.sticks -= 3;
    inventory.stones -= 5;
    inventory.pickaxe = true;
    inventory.pickaxeDurability = 12; // np. 12 użyć
    renderBoard();
  } else {
    alert("❌ Potrzebujesz 3x patyk i 5x kamień.");
  }
}

function craftCampfire() {
  if (inventory.wood >= 5 && inventory.stones >= 3) {
    inventory.wood -= 8;
    inventory.coal -= 4;
    inventory.campfires = (inventory.campfires || 0) + 1;
    renderBoard();
  }
}

function placeCampfire() {
  if (inventory.campfires > 0) {
    campfires.push({ x: playerX, y: playerY });
    inventory.campfires--;
    renderBoard();
  } else {
    alert("Nie masz ogniska do postawienia!");
  }
}

function craftDagger() {
  if (inventory.sticks >= 2 && inventory.stones >= 7) {
    inventory.sticks -= 2;
    inventory.stones -= 7;
    inventory.dagger = true;
    inventory.daggerDurability = 7;
    renderBoard();
  }
}

function craftSword() {
  if (inventory.sticks >= 3 && inventory.stones >= 10) {
    inventory.sticks -= 3;
    inventory.stones -= 10;
    inventory.sword = true;
    inventory.swordDurability = 10;
    renderBoard();
  }
}

function getWorldKey() {
  return `${worldX},${worldY}`;
}

function getCurrentWorld() {
  const key = getWorldKey();
  if (!worlds[key]) {
    worlds[key] = {
      sticks: [], stones: [], trees: [], pigs: [], tomatoes: []
    };
    generateItems(worlds[key].sticks, 10);
    generateItems(worlds[key].stones, 10);
    generateItems(worlds[key].trees, 5);
    generateItems(worlds[key].pigs, 4);
    generateItems(worlds[key].tomatoes, 2);
  }
  return worlds[key];
}

function updateTimeLabel() {
  const label = document.getElementById('timeLabel');
  label.textContent = isDay ? '🌞 Dzień' : '🌙 Noc';
  document.body.style.backgroundColor = isDay ? '#1e1e1e' : '#000';
  if (currentBiome === 'cave') {
    document.body.style.backgroundColor = '#222'; // ciemniejsze tło
  }
}

function toggleDayNight() {
  isDay = !isDay;
  day++;
  
  // Noc: pojawiają się szkielety
  if (!isDay) {
    generateItems(skeletons, 3);
  } else {
    skeletons = [];
  }

  // Dzień: odświeżenie surowców
  if (isDay) {
    sticks = [];
    stones = [];
    trees = [];
    pigs = [];

    generateItems(sticks, 10);
    generateItems(stones, 10);
    generateItems(trees, 5);
    generateItems(carrots, 5);
    generateItems(pigs, 4);
  }

  // Kupiec co 2 dni
  if (day % 2 === 0) {
    spawnMerchant();
  } else {
    merchant = null;
  }

  updateTimeLabel();
  renderBoard();
  saveGame();
}

function openMerchantTrade() {
  const tradeOptions = `
    <h3>👳 Wiejski kupiec</h3>
    <p>Co chcesz wymienić?</p>
    <button onclick="trade('sticks', 5, 'apples', 1)">5x Patyk → 1x Jabłko 🍎</button><br>
    <button onclick="trade('chairs', 4, 'bones', 1)">4x Krzesło → 1x Kość 🦴</button><br>
    <button onclick="trade('stones', 3, 'meat', 1)">3x Kamień → 1x Mięso 🍖</button><br>
    <button onclick="closeMerchant()">Zamknij</button>
  `;
  const ui = document.getElementById('ui');
  ui.innerHTML = tradeOptions;
  ui.classList.add('visible');
}

function trade(from, fromAmt, to, toAmt) {
  if ((inventory[from] || 0) >= fromAmt) {
    inventory[from] -= fromAmt;
    inventory[to] = (inventory[to] || 0) + toAmt;
    updateInventory();
  } else {
    alert("❌ Za mało zasobów do wymiany.");
  }
}

function saveGame() {
  localStorage.setItem('survivalGame', JSON.stringify({
  playerX, playerY, inventory, sticks, stones, trees, cows, coal, pigs, tomatoes, sand, campfires, isDay, playerHP
}));
}

function closeMerchant() {
  const ui = document.getElementById('ui');
  ui.classList.remove('visible');
  ui.innerHTML = '';
}

function loadGame() {
  try {
    const data = JSON.parse(localStorage.getItem('survivalGame'));
    if (data) {
      playerX = data.playerX;
      playerY = data.playerY;
      inventory = data.inventory;
      sticks = data.sticks;
      stones = data.stones;
      trees = data.trees;
      pigs = data.pigs;
      campfires = data.campfires || [];
      tomatoes = data.tomatoes || [];
      isDay = data.isDay;
      sand = data.sand || [];
      coal = data.coal || [];
      cows = data.cows || [];
      cacti = data.cacti || [];
      playerHP = data.playerHP !== undefined ? data.playerHP : 20;
    } else {
      generateMapForBiome();
    }
  } catch (e) {
    console.warn("Błąd podczas ładowania zapisu:", e);
    generateMapForBiome();
  }

  renderBoard();
  generateMapForBiome();
}

function resetGame() {
  if (confirm("❗ Na pewno chcesz zresetować grę? Wszystko zostanie utracone!")) {
    // Reset podstawowych danych
    inventory = {
      sticks: 0, stones: 0, wood: 0, meat: 0, apples: 0,
      tomatoes: 0, sand: 0, coal: 0, cactus: 0, campfires: 0,
      bones: 0, cactusFlower: 0, chairs: 0, carrots: 0,
      sword: false, swordDurability: 0,
      axe: false, axeDurability: 0,
      cookedMeat: 0,
      dagger: false, daggerDurability: 0
    };

    playerHP = 20;
    playerX = 0;
    playerY = 0;
    worldX = 0;
    worldY = 0;
    isDay = true;
    day = 1;

    sticks = [];
    stones = [];
    trees = [];
    pigs = [];
    tomatoes = [];
    sand = [];
    cacti = [];
    campfires = [];
    carrots = [];
    coal = [];
    skeletons = [];
    merchant = null;
    worlds = {};

    localStorage.removeItem('survivalGame');
    generateMapForBiome();
    renderBoard();
    updateInventory();
    updateTimeLabel();
  }
}

document.addEventListener('keydown', e => {
  if (e.key === 'ArrowUp') move('up');
  if (e.key === 'ArrowDown') move('down');
  if (e.key === 'ArrowLeft') move('left');
  if (e.key === 'ArrowRight') move('right');
});

setInterval(toggleDayNight, 30000);
loadGame();
</script>

</body>
</html>